<!DOCTYPE html>
<!-- Generated by pkgdown + https://github.com/insightsengineering/r-pkgdown-multiversion -->
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Add Quality Flags — add_quality_flags • hermes</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Add Quality Flags — add_quality_flags">
<meta name="description" content="
The function add_quality_flags() adds quality flag information to a AnyHermesData object:
low_expression_flag: for each gene, counts how many samples don't pass a minimum
expression Counts per Million (CPM) threshold. If too many, then it flags this gene
as a &quot;low expression&quot; gene.
tech_failure_flag: first calculates the Pearson correlation matrix of the sample wise
CPM values, resulting in a matrix measuring the correlation between samples.
Then compares the average correlation per sample with a threshold - if it is too low,
then the sample is flagged as a &quot;technical failure&quot; sample.
low_depth_flag: computes the library size (total number of counts) per sample.
If this number is too low, the sample is flagged as a &quot;low depth&quot; sample.


Separate helper functions are internally used to create the flags, and
separate getter functions allow easy access to the quality control flags in an object.">
<meta property="og:description" content="
The function add_quality_flags() adds quality flag information to a AnyHermesData object:
low_expression_flag: for each gene, counts how many samples don't pass a minimum
expression Counts per Million (CPM) threshold. If too many, then it flags this gene
as a &quot;low expression&quot; gene.
tech_failure_flag: first calculates the Pearson correlation matrix of the sample wise
CPM values, resulting in a matrix measuring the correlation between samples.
Then compares the average correlation per sample with a threshold - if it is too low,
then the sample is flagged as a &quot;technical failure&quot; sample.
low_depth_flag: computes the library size (total number of counts) per sample.
If this number is too low, the sample is flagged as a &quot;low depth&quot; sample.


Separate helper functions are internally used to create the flags, and
separate getter functions allow easy access to the quality control flags in an object.">
<meta property="og:image" content="https://insightsengineering.github.io/hermes/logo.png">
<!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-125641273-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-125641273-1');
</script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">hermes</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.7.2.9004</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/hermes.html">Get started</a></li>
<li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      <div><li class="nav-item dropdown">
    <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-versions">Versions</a>
    <div class="dropdown-menu" aria-labelledby="dropdown-versions">
    <a class="dropdown-item" data-toggle="tooltip" title="" href="https://insightsengineering.github.io/hermes/main">main</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://insightsengineering.github.io/hermes/latest-tag">latest-tag</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://insightsengineering.github.io/hermes/v1.7.2">v1.7.2</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://insightsengineering.github.io/hermes/v1.7.1">v1.7.1</a>
</div>
</li></div>
</ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/insightsengineering/hermes"><span class="fa fa-github"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Add Quality Flags</h1>
      <small class="dont-index">Source: <a href="https://github.com/insightsengineering/hermes/blob/main/R/quality.R" class="external-link"><code>R/quality.R</code></a></small>
      <div class="d-none name"><code>quality_flags.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p><a href="https://lifecycle.r-lib.org/articles/stages.html#stable" class="external-link"><img src="figures/lifecycle-stable.svg" alt="[Stable]"></a></p>
<p>The function <code>add_quality_flags()</code> adds quality flag information to a <code><a href="HermesData-class.html">AnyHermesData</a></code> object:</p>
<ul>
<li><p><code>low_expression_flag</code>: for each gene, counts how many samples don't pass a minimum
expression Counts per Million (<code>CPM</code>) threshold. If too many, then it flags this gene
as a "low expression" gene.</p></li>
<li><p><code>tech_failure_flag</code>: first calculates the Pearson correlation matrix of the sample wise
<code>CPM</code> values, resulting in a matrix measuring the correlation between samples.
Then compares the average correlation per sample with a threshold - if it is too low,
then the sample is flagged as a "technical failure" sample.</p></li>
<li><p><code>low_depth_flag</code>: computes the library size (total number of counts) per sample.
If this number is too low, the sample is flagged as a "low depth" sample.</p></li>
</ul>
<p>Separate helper functions are internally used to create the flags, and
separate <code>getter</code> functions allow easy access to the quality control flags in an object.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a>
</h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">add_quality_flags</span><span class="op">(</span><span class="va">object</span>, control <span class="op">=</span> <span class="fu"><a href="control_quality.html">control_quality</a></span><span class="op">(</span><span class="op">)</span>, overwrite <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">h_low_expression_flag</span><span class="op">(</span><span class="va">object</span>, control <span class="op">=</span> <span class="fu"><a href="control_quality.html">control_quality</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">h_low_depth_flag</span><span class="op">(</span><span class="va">object</span>, control <span class="op">=</span> <span class="fu"><a href="control_quality.html">control_quality</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">h_tech_failure_flag</span><span class="op">(</span><span class="va">object</span>, control <span class="op">=</span> <span class="fu"><a href="control_quality.html">control_quality</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">get_tech_failure</span><span class="op">(</span><span class="va">object</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">get_low_depth</span><span class="op">(</span><span class="va">object</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">get_low_expression</span><span class="op">(</span><span class="va">object</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a>
</h2>


<dl>
<dt id="arg-object">object<a class="anchor" aria-label="anchor" href="#arg-object"></a>
</dt>
<dd><p>(<code>AnyHermesData</code>) <br> input.</p></dd>


<dt id="arg-control">control<a class="anchor" aria-label="anchor" href="#arg-control"></a>
</dt>
<dd><p>(<code>list</code>) <br> list of settings (thresholds etc.) used to compute the
quality control flags, produced by <code><a href="control_quality.html">control_quality()</a></code>.</p></dd>


<dt id="arg-overwrite">overwrite<a class="anchor" aria-label="anchor" href="#arg-overwrite"></a>
</dt>
<dd><p>(<code>flag</code>)<br> whether previously added flags may be overwritten.</p></dd>

</dl>
</div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a>
</h2>
    <p>The input object with added quality flags.</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a>
</h2>
    <p>While <code>object</code> already has the variables mentioned above as part of the
<code>rowData</code> and <code>colData</code> (as this is enforced by the validation
method for <code><a href="HermesData-class.html">AnyHermesData</a></code>), they are usually still <code>NA</code> after the initial
object creation.</p>
    </div>
    <div class="section level2">
    <h2 id="functions">Functions<a class="anchor" aria-label="anchor" href="#functions"></a>
</h2>

<ul>
<li><p><code>h_low_expression_flag()</code>: creates the low expression flag for genes
given control settings.</p></li>
<li><p><code>h_low_depth_flag()</code>: creates the low depth (library size) flag for samples
given control settings.</p></li>
<li><p><code>h_tech_failure_flag()</code>: creates the technical failure flag for samples
given control settings.</p></li>
<li><p><code>get_tech_failure()</code>: get the technical failure flags for all samples.</p></li>
<li><p><code>get_low_depth()</code>: get the low depth failure flags for all samples.</p></li>
<li><p><code>get_low_expression()</code>: get the low expression failure flags for all genes.</p></li>
</ul>
</div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a>
</h2>
    <div class="dont-index">
<ul>
<li><p><code><a href="control_quality.html">control_quality()</a></code> for the detailed settings specifications;</p></li>
<li><p><code><a href="set_tech_failure.html">set_tech_failure()</a></code> to manually flag samples as technical failures.</p></li>
</ul>
</div>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a>
</h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="co"># Adding default quality flags to `AnyHermesData` object.</span></span></span>
<span class="r-in"><span><span class="va">object</span> <span class="op">&lt;-</span> <span class="va">hermes_data</span></span></span>
<span class="r-in"><span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu">add_quality_flags</span><span class="op">(</span><span class="va">object</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu">get_tech_failure</span><span class="op">(</span><span class="va">result</span><span class="op">)</span> <span class="op">!=</span> <span class="fu">get_tech_failure</span><span class="op">(</span><span class="va">object</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 06520046C0018R </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             10 </span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu">get_low_expression</span><span class="op">(</span><span class="va">result</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     GeneID:11185     GeneID:10677 GeneID:101928428 GeneID:100422835 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>            FALSE            FALSE             TRUE             TRUE </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> GeneID:102466731     GeneID:64881 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             TRUE             TRUE </span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu">get_tech_failure</span><span class="op">(</span><span class="va">result</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 06520011B0023R 06520067C0018R 06520063C0043R 06520105C0017R 06520092C0017R </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          FALSE          FALSE          FALSE          FALSE          FALSE </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 06520103C0017R </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          FALSE </span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu">get_low_depth</span><span class="op">(</span><span class="va">result</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 06520011B0023R 06520067C0018R 06520063C0043R 06520105C0017R 06520092C0017R </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          FALSE          FALSE          FALSE          FALSE          FALSE </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 06520103C0017R </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          FALSE </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># It is possible to overwrite flags if needed, which will trigger a message.</span></span></span>
<span class="r-in"><span><span class="va">result2</span> <span class="op">&lt;-</span> <span class="fu">add_quality_flags</span><span class="op">(</span><span class="va">result</span>, <span class="fu"><a href="control_quality.html">control_quality</a></span><span class="op">(</span>min_cpm <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span>, overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> previously have added quality flags, but overwriting now</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Separate calculation of low expression flag.</span></span></span>
<span class="r-in"><span><span class="va">low_expr_flag</span> <span class="op">&lt;-</span> <span class="fu">h_low_expression_flag</span><span class="op">(</span></span></span>
<span class="r-in"><span>  <span class="va">object</span>,</span></span>
<span class="r-in"><span>  <span class="fu"><a href="control_quality.html">control_quality</a></span><span class="op">(</span>min_cpm <span class="op">=</span> <span class="fl">500</span>, min_cpm_prop <span class="op">=</span> <span class="fl">0.9</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">low_expr_flag</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">object</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] TRUE</span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">low_expr_flag</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     GeneID:11185     GeneID:10677 GeneID:101928428 GeneID:100422835 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             TRUE             TRUE             TRUE             TRUE </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> GeneID:102466731     GeneID:64881 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             TRUE             TRUE </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Separate calculation of low depth flag.</span></span></span>
<span class="r-in"><span><span class="va">low_depth_flag</span> <span class="op">&lt;-</span> <span class="fu">h_low_depth_flag</span><span class="op">(</span><span class="va">object</span>, <span class="fu"><a href="control_quality.html">control_quality</a></span><span class="op">(</span>min_depth <span class="op">=</span> <span class="fl">5</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">low_depth_flag</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">object</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] TRUE</span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">low_depth_flag</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 06520011B0023R 06520067C0018R 06520063C0043R 06520105C0017R 06520092C0017R </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          FALSE          FALSE          FALSE          FALSE          FALSE </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 06520103C0017R </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          FALSE </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Separate calculation of technical failure flag.</span></span></span>
<span class="r-in"><span><span class="va">tech_failure_flag</span> <span class="op">&lt;-</span> <span class="fu">h_tech_failure_flag</span><span class="op">(</span><span class="va">object</span>, <span class="fu"><a href="control_quality.html">control_quality</a></span><span class="op">(</span>min_corr <span class="op">=</span> <span class="fl">0.35</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">tech_failure_flag</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">object</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] TRUE</span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">tech_failure_flag</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 06520011B0023R 06520067C0018R 06520063C0043R 06520105C0017R 06520092C0017R </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          FALSE          FALSE          FALSE          FALSE          FALSE </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 06520103C0017R </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          FALSE </span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu">get_tech_failure</span><span class="op">(</span><span class="va">object</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 06520011B0023R 06520067C0018R 06520063C0043R 06520105C0017R 06520092C0017R </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          FALSE          FALSE          FALSE          FALSE          FALSE </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 06520103C0017R </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          FALSE </span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu">get_low_depth</span><span class="op">(</span><span class="va">object</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 06520011B0023R 06520067C0018R 06520063C0043R 06520105C0017R 06520092C0017R </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          FALSE          FALSE           TRUE          FALSE          FALSE </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 06520103C0017R </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          FALSE </span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu">get_low_expression</span><span class="op">(</span><span class="va">object</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     GeneID:11185     GeneID:10677 GeneID:101928428 GeneID:100422835 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>            FALSE             TRUE             TRUE             TRUE </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> GeneID:102466731     GeneID:64881 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             TRUE             TRUE </span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Daniel Sabanés Bové, Namrata Bhatia, Stefanie Bienert, Benoit Falquet, Haocheng Li, Jeff Luong, Lyndsee Midori Zhang, Alex Richardson, Simona Rossomanno, Tim Treis, Mark Yan, Naomi Chang, Chendi Liao, Carolyn Zhang, Joseph N. Paulson, F. Hoffmann-La Roche AG.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
